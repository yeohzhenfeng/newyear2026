<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Happy New Year</title>

<style>
  html,body{
    margin:0;
    width:100%;
    height:100%;
    background:#000;
    overflow:hidden;
  }
  canvas{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    display:block;
  }
  #bg{ z-index:1; }
  #ui{ z-index:2; }
  .tip{
    position:fixed;
    left:50%;
    bottom:16px;
    transform:translateX(-50%);
    z-index:3;
    padding:10px 14px;
    border-radius:999px;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.18);
    color:rgba(255,255,255,.9);
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
    backdrop-filter: blur(6px);
    pointer-events:none;
    font-size:14px;
  }
</style>
</head>

<body>
<canvas id="bg"></canvas>
<canvas id="ui"></canvas>
<div class="tip">如果你在手机：点击一下屏幕开始音乐/动画更顺</div>

<script>
/* ===============================
   高清 Canvas
================================ */
function fitCanvas(cvs, ctx){
  const dpr = Math.min(3, window.devicePixelRatio || 1);
  const rect = cvs.getBoundingClientRect();
  cvs.width  = Math.round(rect.width * dpr);
  cvs.height = Math.round(rect.height * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  return { w: rect.width, h: rect.height };
}

/* ✅ 正确取元素（不会报错） */
const bgCanvas = document.getElementById('bg');
const uiCanvas = document.getElementById('ui');
const bgCtx = bgCanvas.getContext('2d', { alpha:true });
const uiCtx = uiCanvas.getContext('2d', { alpha:true });

let W=0, H=0;

/* ===============================
   背景烟花（轻量）
================================ */
let sparks=[];

function rand(a,b){ return a + Math.random()*(b-a); }

function spawnFirework(){
  const x = rand(W*0.15, W*0.85);
  const y = rand(H*0.12, H*0.45);
  const hue = rand(0, 360);
  const count = Math.floor(rand(36, 60));

  for(let i=0;i<count;i++){
    const ang = Math.random()*Math.PI*2;
    const sp = rand(1.2, 3.4);
    sparks.push({
      x,y,
      vx: Math.cos(ang)*sp,
      vy: Math.sin(ang)*sp,
      life: Math.floor(rand(40, 80)),
      age:0,
      hue
    });
  }
}

function drawBG(){
  // 尾迹淡出
  bgCtx.fillStyle = 'rgba(0,0,0,0.22)';
  bgCtx.fillRect(0,0,W,H);

  if(Math.random() < 0.04) spawnFirework();

  for(let i=sparks.length-1;i>=0;i--){
    const s = sparks[i];
    s.age++;
    s.x += s.vx;
    s.y += s.vy;
    s.vy += 0.02; // 重力
    s.vx *= 0.985;
    s.vy *= 0.985;

    const a = Math.max(0, 1 - s.age/s.life);
    bgCtx.fillStyle = `hsla(${s.hue},100%,70%,${a})`;
    bgCtx.beginPath();
    bgCtx.arc(s.x, s.y, 2.0, 0, Math.PI*2);
    bgCtx.fill();

    if(s.age >= s.life) sparks.splice(i,1);
  }
}

/* ===============================
   UI：清晰实心字 + 最后男女+LOVE
================================ */
const fontStack = '-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Arial,sans-serif';

let mode = 'text';       // countdown | text | love
let currentText = '';
let timer = 0;
let countdown = 5;

function drawUI(){
  uiCtx.clearRect(0,0,W,H);

  uiCtx.textAlign='center';
  uiCtx.textBaseline='middle';

  // 统一一点发光
  uiCtx.shadowColor = 'rgba(255,255,255,0.65)';
  uiCtx.shadowBlur = 18;

  if(mode === 'countdown'){
    uiCtx.font = '900 140px ' + fontStack;
    uiCtx.fillStyle = '#fff';
    uiCtx.fillText(String(countdown), W/2, H/2);
    return;
  }

  if(mode === 'text'){
    // 根据屏幕自动字号，确保不被裁切
    let size = Math.min(64, Math.max(28, Math.floor(W/18)));
    uiCtx.font = '800 ' + size + 'px ' + fontStack;

    // 如果太长就缩小
    const maxW = W * 0.88;
    while(uiCtx.measureText(currentText).width > maxW && size > 18){
      size -= 2;
      uiCtx.font = '800 ' + size + 'px ' + fontStack;
    }

    uiCtx.fillStyle = '#fff';
    uiCtx.fillText(currentText, W/2, H/2);
    return;
  }

  if(mode === 'love'){
    // 画一男一女（简单几何图形） + LOVE
    uiCtx.shadowBlur = 22;
    uiCtx.fillStyle = '#fff';

    const baseX = W/2 - 160;
    const baseY = H/2 + 10;

    // 男
    uiCtx.beginPath();
    uiCtx.arc(baseX, baseY-70, 22, 0, Math.PI*2);
    uiCtx.fill();
    uiCtx.fillRect(baseX-18, baseY-48, 36, 78);
    uiCtx.fillRect(baseX-48, baseY-30, 96, 18);

    // 女
    const gx = baseX + 90;
    uiCtx.beginPath();
    uiCtx.arc(gx, baseY-70, 22, 0, Math.PI*2);
    uiCtx.fill();
    uiCtx.beginPath();
    uiCtx.moveTo(gx-42, baseY-20);
    uiCtx.lineTo(gx+42, baseY-20);
    uiCtx.lineTo(gx, baseY+90);
    uiCtx.closePath();
    uiCtx.fill();
    uiCtx.fillRect(gx-42, baseY-30, 84, 18);

    // LOVE
    uiCtx.font = '900 90px ' + fontStack;
    uiCtx.fillText('LOVE', W/2 + 180, H/2 + 30);
  }
}

/* ===============================
   时间线（不会空白）
================================ */
const steps = [
  { type:'countdown', ms:1000 }, // 每秒减一次
  { type:'text', text:'HAPPY NEW YEAR', ms:2200 },
  { type:'text', text:'Little Fairy', ms:1800 },
  { type:'text', text:'May your hard work pay off', ms:2400 },
  { type:'text', text:'Focus. Believe. Achieve.', ms:2400 },
  { type:'love', ms:999999 } // 最后常驻
];

let stepIndex = 0;

function applyStep(idx){
  stepIndex = Math.min(idx, steps.length-1);
  timer = 0;

  const s = steps[stepIndex];
  mode = s.type;

  if(s.type === 'countdown'){
    countdown = 5;
  } else if(s.type === 'text'){
    currentText = s.text;
  } else {
    currentText = '';
  }
}

applyStep(0);

/* ===============================
   主循环
================================ */
let last = performance.now();
function loop(now){
  const dt = now - last;
  last = now;

  drawBG();
  drawUI();

  const s = steps[stepIndex];
  timer += dt;

  if(s.type === 'countdown'){
    if(timer >= s.ms){
      timer = 0;
      countdown--;
      if(countdown <= 0){
        applyStep(stepIndex + 1);
      }
    }
  } else {
    if(timer >= s.ms && s.type !== 'love'){
      applyStep(stepIndex + 1);
    }
  }

  requestAnimationFrame(loop);
}

/* ===============================
   Resize
================================ */
function resize(){
  const a = fitCanvas(bgCanvas, bgCtx);
  const b = fitCanvas(uiCanvas, uiCtx);
  W = a.w; H = a.h;
}
window.addEventListener('resize', resize, {passive:true});
resize();
requestAnimationFrame(loop);
</script>
</body>
</html>
