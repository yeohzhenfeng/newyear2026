<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Happy New Year</title>
  <style>
    html,body{ margin:0; height:100%; background:#000; overflow:hidden; }
    canvas{ position:fixed; inset:0; width:100%; height:100%; display:block; }
    #fx { z-index: 1; }
    #txt{ z-index: 2; }

    /* 点击开始提示 */
    .hint{
      position:fixed; inset:auto 0 18px 0;
      z-index: 3;
      display:flex; justify-content:center;
      pointer-events:none;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      color:rgba(255,255,255,.85);
      text-shadow:0 6px 18px rgba(0,0,0,.55);
      letter-spacing:.5px;
      font-size:14px;
    }
    .pill{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>
  <canvas id="txt"></canvas>

  <!-- 你要换歌：把 src 改成你自己的 mp3 链接即可 -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://webfs.ali.kugou.com/202212311401/c12fd67b0106b68294c3eb354aec3786/part/0/1516896/KGTX/CLTX001/clip_488850641544fb4c6e14e6b8356d084f.mp3" type="audio/mpeg">
  </audio>

  <div class="hint" id="hint"><div class="pill">Tap / Click anywhere to start ✨</div></div>

<script>
/* =========================
   0) HiDPI helper
========================= */
function fitCanvas(cvs, ctx){
  const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  const rect = cvs.getBoundingClientRect();
  cvs.width  = Math.round(rect.width  * dpr);
  cvs.height = Math.round(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return { w: rect.width, h: rect.height, dpr };
}

/* =========================
   1) Fireworks (simple, no external images)
========================= */
const fxCvs = document.getElementById('fx');
const fxCtx = fxCvs.getContext('2d', { alpha:true });

let VW=0, VH=0;
let fireworks = [];
let particles = [];
let lastT = 0;

function rand(a,b){ return a + Math.random()*(b-a); }

function spawnFirework(){
  const x = rand(VW*0.15, VW*0.85);
  const y = VH + 10;
  const tx = x + rand(-VW*0.15, VW*0.15);
  const ty = rand(VH*0.15, VH*0.45);
  fireworks.push({
    x, y, vx:(tx-x)/rand(35,55), vy:(ty-y)/rand(35,55),
    t:0, tt: rand(35,55),
    hue: rand(0,360)
  });
}

function explode(x,y,hue){
  const count = Math.floor(rand(48,90));
  for(let i=0;i<count;i++){
    const a = Math.random()*Math.PI*2;
    const sp = rand(1.6, 4.6);
    particles.push({
      x,y,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      life: rand(40,80),
      age:0,
      hue,
      r: rand(1.2, 2.8)
    });
  }
}

function stepFX(dt){
  // 背景淡出（尾迹）
  fxCtx.fillStyle = 'rgba(0,0,0,0.18)';
  fxCtx.fillRect(0,0,VW,VH);

  // 偶尔发射
  if(Math.random() < 0.06) spawnFirework();

  // 火箭
  for(let i=fireworks.length-1;i>=0;i--){
    const f = fireworks[i];
    f.t += dt*60;
    f.x += f.vx*dt*60;
    f.y += f.vy*dt*60;
    f.vy += 0.02*dt*60; // 重力

    // 火箭亮点
    fxCtx.beginPath();
    fxCtx.fillStyle = `hsla(${f.hue},100%,70%,0.9)`;
    fxCtx.arc(f.x, f.y, 2.2, 0, Math.PI*2);
    fxCtx.fill();

    if(f.t >= f.tt){
      explode(f.x, f.y, f.hue);
      fireworks.splice(i,1);
    }
  }

  // 爆炸粒子
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.age += dt*60;
    p.x += p.vx*dt*60;
    p.y += p.vy*dt*60;
    p.vy += 0.03*dt*60; // 重力
    p.vx *= 0.985;
    p.vy *= 0.985;

    const a = Math.max(0, 1 - p.age/p.life);
    fxCtx.beginPath();
    fxCtx.fillStyle = `hsla(${p.hue},100%,70%,${a})`;
    fxCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    fxCtx.fill();

    if(p.age >= p.life) particles.splice(i,1);
  }
}

/* =========================
   2) Particle Text (stable)
========================= */
const txtCvs = document.getElementById('txt');
const txtCtx = txtCvs.getContext('2d', { alpha:true });

const fontStack = `-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",Arial,sans-serif`;

const off = document.createElement('canvas');
const offCtx = off.getContext('2d');

let dots = [];
let targetDots = [];
let dotCount = 1200;     // 粒子数量（会根据文字自动补/减）
let gap = 6;             // 采样密度（越小越清晰，越大越省性能）
let holdMs = 2800;       // 每句停留时间
let morphSpeed = 0.12;   // 变形速度（0.08~0.18）

function buildDotsFromText(text){
  off.width = VW; off.height = VH;
  offCtx.clearRect(0,0,VW,VH);

  // 自动字体大小：按屏幕适配，手机不会挤爆
  const maxW = VW*0.84;
  let size = Math.min(160, Math.max(64, Math.floor(VW/8)));
  offCtx.textAlign='center';
  offCtx.textBaseline='middle';
  offCtx.fillStyle='#fff';

  // 先用较大字号测量，再缩放
  offCtx.font = `700 ${size}px ${fontStack}`;
  while(offCtx.measureText(text).width > maxW && size > 44){
    size -= 6;
    offCtx.font = `700 ${size}px ${fontStack}`;
  }

  // 渲染文字到 offscreen
  offCtx.fillText(text, VW/2, VH/2);

  const img = offCtx.getImageData(0,0,VW,VH).data;
  const pts = [];
  for(let y=0;y<VH;y+=gap){
    for(let x=0;x<VW;x+=gap){
      const a = img[(y*VW + x)*4 + 3];
      if(a > 12) pts.push({x,y});
    }
  }
  return pts;
}

function buildDotsFromSVG(svgText){
  // 将 SVG 转成图片再采样
  return new Promise((resolve)=>{
    const blob = new Blob([svgText], {type:'image/svg+xml'});
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = ()=>{
      off.width = VW; off.height = VH;
      offCtx.clearRect(0,0,VW,VH);

      // 等比居中缩放
      const targetW = VW*0.88;
      const targetH = VH*0.40;
      const scale = Math.min(targetW/img.width, targetH/img.height);
      const dw = img.width*scale;
      const dh = img.height*scale;
      const dx = (VW - dw)/2;
      const dy = (VH - dh)/2;

      offCtx.drawImage(img, dx, dy, dw, dh);

      const data = offCtx.getImageData(0,0,VW,VH).data;
      const pts=[];
      for(let y=0;y<VH;y+=gap){
        for(let x=0;x<VW;x+=gap){
          const a = data[(y*VW + x)*4 + 3];
          if(a>12) pts.push({x,y});
        }
      }
      URL.revokeObjectURL(url);
      resolve(pts);
    };
    img.src = url;
  });
}

function ensureDots(n){
  while(dots.length < n){
    dots.push({
      x: rand(0,VW), y: rand(0,VH),
      vx:0, vy:0
    });
  }
  while(dots.length > n){
    dots.pop();
  }
}

function setTarget(pts){
  // 目标点随机抽样到 dotCount，避免点太多太卡
  if(pts.length === 0) pts = [{x:VW/2,y:VH/2}];
  const chosen = [];
  for(let i=0;i<dotCount;i++){
    const p = pts[Math.floor(Math.random()*pts.length)];
    chosen.push(p);
  }
  targetDots = chosen;
  ensureDots(dotCount);
}

function stepText(){
  txtCtx.clearRect(0,0,VW,VH);

  // 小发光
  txtCtx.globalCompositeOperation = 'lighter';

  for(let i=0;i<dots.length;i++){
    const d = dots[i];
    const t = targetDots[i] || {x:VW/2,y:VH/2};

    // 简单“弹簧”追踪
    d.vx += (t.x - d.x) * morphSpeed;
    d.vy += (t.y - d.y) * morphSpeed;
    d.vx *= 0.78;
    d.vy *= 0.78;
    d.x += d.vx;
    d.y += d.vy;

    const sp = Math.hypot(d.vx,d.vy);
    const alpha = Math.max(0.18, Math.min(0.95, 0.35 + sp*0.18));

    txtCtx.beginPath();
    txtCtx.fillStyle = `rgba(255,255,255,${alpha})`;
    txtCtx.arc(d.x, d.y, 1.6, 0, Math.PI*2);
    txtCtx.fill();
  }

  txtCtx.globalCompositeOperation = 'source-over';
}

/* =========================
   3) Sequence control
========================= */
const sequence = [
  { type:'countdown', from:5, stepMs: 900 },
  { type:'text', value:'HAPPY NEW YEAR', hold: 2600 },
  { type:'text', value:'Little Fairy', hold: 2200 },
  { type:'text', value:'May your hard work pay off', hold: 2600 },
  { type:'text', value:'and bring you great results', hold: 2600 },
  { type:'text', value:'Focus. Believe. Achieve.', hold: 2600 },
  { type:'love', hold: 999999 } // 最后常驻
];

let seqIndex = 0;
let seqTimer = 0;
let countdownValue = 0;

async function gotoStep(i){
  seqIndex = i;
  seqTimer = 0;
  const step = sequence[seqIndex];

  if(step.type === 'text'){
    setTarget(buildDotsFromText(step.value));
    holdMs = step.hold ?? holdMs;
  }

  if(step.type === 'countdown'){
    countdownValue = step.from;
    setTarget(buildDotsFromText(String(countdownValue)));
  }

  if(step.type === 'love'){
    // 一男一女 + LOVE 同时出现（SVG，稳定不变形）
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1000" height="300" viewBox="0 0 1000 300">
        <rect width="100%" height="100%" fill="black"/>
        <g fill="white">
          <!-- 男（简洁） -->
          <g transform="translate(220,70)">
            <circle cx="0" cy="0" r="40"/>
            <rect x="-22" y="45" width="44" height="110" rx="20"/>
            <rect x="-70" y="70" width="140" height="26" rx="13"/>
            <rect x="-50" y="150" width="24" height="90" rx="12"/>
            <rect x="26" y="150" width="24" height="90" rx="12"/>
          </g>

          <!-- 女（简洁裙摆） -->
          <g transform="translate(360,70)">
            <circle cx="0" cy="0" r="40"/>
            <path d="M-78,165 C-58,80 -28,45 0,45 C28,45 58,80 78,165
                     L48,165 L28,255 L-28,255 L-48,165 Z"/>
            <rect x="-60" y="70" width="120" height="26" rx="13"/>
          </g>

          <!-- LOVE -->
          <text x="670" y="195"
            font-family="${fontStack.replaceAll('"',"'")}"
            font-size="160" font-weight="800"
            letter-spacing="12" text-anchor="middle">LOVE</text>
        </g>
      </svg>
    `;
    const pts = await buildDotsFromSVG(svg);
    setTarget(pts);
    holdMs = step.hold ?? holdMs;
  }
}

function advanceSequence(dtMs){
  const step = sequence[seqIndex];

  if(step.type === 'countdown'){
    seqTimer += dtMs;
    if(seqTimer >= step.stepMs){
      seqTimer = 0;
      countdownValue--;
      if(countdownValue <= 0){
        gotoStep(seqIndex + 1);
      }else{
        setTarget(buildDotsFromText(String(countdownValue)));
      }
    }
    return;
  }

  // text / love
  seqTimer += dtMs;
  const limit = step.hold ?? holdMs;
  if(seqTimer >= limit && step.type !== 'love'){
    gotoStep(seqIndex + 1);
  }
}

/* =========================
   4) Main loop
========================= */
function loop(t){
  const dt = Math.min(0.033, (t - lastT)/1000 || 0.016);
  lastT = t;

  stepFX(dt);
  stepText();
  advanceSequence(dt*1000);

  requestAnimationFrame(loop);
}

/* =========================
   5) Start (tap to enable audio)
========================= */
function resizeAll(){
  const a = fitCanvas(fxCvs, fxCtx);
  const b = fitCanvas(txtCvs, txtCtx);
  VW = a.w; VH = a.h;
}
window.addEventListener('resize', ()=>{ resizeAll(); gotoStep(seqIndex); }, {passive:true});

resizeAll();
gotoStep(0);
requestAnimationFrame(loop);

// audio: mobile needs gesture
const bgm = document.getElementById('bgm');
const hint = document.getElementById('hint');
let started = false;

async function startEverything(){
  if(started) return;
  started = true;
  hint.style.display = 'none';
  try { await bgm.play(); } catch(e) {}
}
document.addEventListener('click', startEverything, {passive:true});
document.addEventListener('touchstart', startEverything, {passive:true});
</script>
</body>
</html>
